import telebot
from telebot.types import Message
from pymongo import MongoClient
from config import BOT_TOKEN, MONGO_URI, DB_NAME, CHANNEL_ID

bot = telebot.TeleBot(BOT_TOKEN)

# MongoDB
client = MongoClient(MONGO_URI)
db = client[DB_NAME]
files_col = db["files"]

@bot.message_handler(commands=["start"])
def start(message: Message):
    bot.reply_to(message, "👋 Welcome to Telegram Cloud!\n\n"
                          "Use:\n"
                          "📤 /newfile - Upload a file\n"
                          "📥 /getfile <file_id> - Retrieve a file")

@bot.message_handler(commands=["newfile"])
def ask_file(message: Message):
    bot.reply_to(message, "📤 Send me the file to upload")

@bot.message_handler(content_types=["document", "video", "audio"])
def handle_file(message: Message):
    file = message.document or message.video or message.audio
    file_id = file.file_id
    file_name = file.file_name if message.document else "file"

    # Save in MongoDB
    file_doc = {"tg_file_id": file_id, "name": file_name}
    result = files_col.insert_one(file_doc)
    db_id = str(result.inserted_id)

    bot.reply_to(message, f"✅ File uploaded!\n\n"
                          f"🆔 File ID: {db_id}\n\n"
                          f"Use /getfile {db_id} to download later.", parse_mode="Markdown")

@bot.message_handler(commands=["getfile"])
def get_file(message: Message):
    try:
        fid = message.text.split(" ")[1]
    except:
        return bot.reply_to(message, "⚠️ Usage: /getfile <file_id>")

    file_doc = files_col.find_one({"_id": import("bson").ObjectId(fid)})
    if not file_doc:
        return bot.reply_to(message, "❌ File not found")

    bot.send_document(message.chat.id, file_doc["tg_file_id"], caption=f"📂 {file_doc['name']}")

print("🤖 Bot is running...")
bot.polling()